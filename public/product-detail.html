<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="style.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Product Detail</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
    }
    h1 {
      margin-top: 20px;
      color: #002f34;
    }
    p {
      font-size: 16px;
      margin: 10px 0;
    }
    .price {
      font-size: 26px;
      font-weight: bold;
      color: #ce0404;
    }
    .buttons {
      margin-top: 30px;
    }
 .buttons button {
  padding: 8px 18px;          /* Smaller padding for compact buttons */
  margin-right: 10px;         /* Slightly reduced margin */
  border: none;
  border-radius: 8px;         /* Slightly more rounded for modern feel */
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;            /* Smaller font size */
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);  /* Soft shadow for depth */
}

.buttons button:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  filter: brightness(1.1);    /* Slightly brighten on hover */
}

/* Button colors with smooth hover variations */
.buy-btn {
  background-color: #28a745;
  color: white;
}

.buy-btn:hover {
  background-color: #218838;
}

.cart-btn {
  background-color: #007bff;
  color: white;
}

.cart-btn:hover {
  background-color: #0069d9;
}

.cancel-btn {
  background-color: #dc3545;
  color: white;
}

.cancel-btn:hover {
  background-color: #c82333;
}


    /* Related products styles */
    #relatedProducts {
      max-width: 800px;
      margin: 40px auto 0;
      background: white;
      padding: 20px 30px 30px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #relatedProducts h2 {
      color: #002f34;
      margin-bottom: 20px;
      font-weight: 700;
    }
    .related-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
    }
    .related-card {
      background: #fafafa;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      text-align: center;
      padding: 10px;
    }
    .related-card:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .related-card img {
      width: 100px;
      height: 133px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .related-title {
      font-weight: bold;
      color: #002f34;
      font-size: 14px;
      margin-bottom: 6px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .related-price {
      color: #ce0404;
      font-weight: bold;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div class="container" id="productDetail">
    <p>Loading product...</p>
  </div>

  <div id="relatedProducts" style="display:none;">
    <h2>Related Products</h2>
    <div class="related-grid" id="relatedGrid"></div>
  </div>

  <script>
    const SERVER_BASE_URL = 'https://milegabhai.onrender.com';
    const container = document.getElementById('productDetail');
    const relatedSection = document.getElementById('relatedProducts');
    const relatedGrid = document.getElementById('relatedGrid');
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    let currentProduct = null;

    // Load user from localStorage
    let user = null;
    try {
      const userStr = localStorage.getItem('user');
      user = userStr ? JSON.parse(userStr) : null;
      console.log('Logged-in user:', user);
    } catch (e) {
      console.error('Failed to parse user from localStorage:', e);
    }

    if (!productId) {
      container.innerHTML = '<p>Product not found.</p>';
      throw new Error('No product ID in URL');
    }

    // Fetch main product details
    fetch(`${SERVER_BASE_URL}/api/products/${productId}`)
      .then(res => {
        if (!res.ok) throw new Error(`Failed to fetch product: ${res.status}`);
        return res.json();
      })
      .then(product => {
        currentProduct = product;

        const imageUrl = product.image.startsWith('https')
          ? product.image
          : SERVER_BASE_URL + product.image;

        container.innerHTML = `
          <img src="${imageUrl}" alt="${product.title}">
          <h1>${product.title}</h1>
          <p class="price">₹${Number(product.price).toLocaleString()}</p>
          <p><strong>Description:</strong> ${product.description || 'No description provided.'}</p>
          <p><strong>Condition:</strong> ${product.condition || 'N/A'}</p>
          <p><strong>Location:</strong> ${product.location || 'Unknown'}</p>
          <div class="buttons">
            <button class="buy-btn" onclick="buyNow()">Buy Now</button>
            <button class="cart-btn" onclick="addToCart()">Cart</button>
            <button class="cancel-btn" onclick="window.history.back()">Cancel</button>
          </div>
        `;

        loadRelatedProductsByTitle(product.title);
      })
      .catch(err => {
        console.error(err);
        container.innerHTML = '<p>Failed to load product.</p>';
      });

    // Helper: extract keywords from title (basic split by spaces and filter short words)
    function getTitleKeywords(title) {
      if (!title) return [];
      return title
        .toLowerCase()
        .split(/\s+/)
        .filter(word => word.length > 2) // ignore very short words like "of", "in"
        .slice(0, 3); // limit to first 3 keywords
    }

    // Fetch related products by matching title keywords
    function loadRelatedProductsByTitle(title) {
      const keywords = getTitleKeywords(title);
      if (keywords.length === 0) {
        loadRandomRelatedProducts();
        return;
      }

      // Use first keyword for searching related products
      const searchKeyword = keywords[0];

      fetch(`${SERVER_BASE_URL}/api/products?search=${encodeURIComponent(searchKeyword)}&limit=6`)
        .then(res => {
          if (!res.ok) throw new Error('Failed to fetch related products');
          return res.json();
        })
        .then(products => {
          // Exclude current product
          const filtered = products.filter(p => p._id !== productId).slice(0,6);
          if (filtered.length) {
            displayRelatedProducts(filtered);
          } else {
            // fallback to random products if no related found
            loadRandomRelatedProducts();
          }
        })
        .catch(err => {
          console.error('Error loading related products:', err);
          loadRandomRelatedProducts();
        });
    }

    // Load random related products fallback
    function loadRandomRelatedProducts() {
      fetch(`${SERVER_BASE_URL}/api/products?limit=6`)
        .then(res => res.json())
        .then(products => {
          const filtered = products.filter(p => p._id !== productId).slice(0,6);
          displayRelatedProducts(filtered);
        })
        .catch(err => {
          console.error('Failed to load random related products', err);
          relatedSection.style.display = 'none';
        });
    }

    function displayRelatedProducts(products) {
      if (!products || products.length === 0) {
        relatedSection.style.display = 'none';
        return;
      }

      relatedGrid.innerHTML = products.map(p => {
        const img = p.image.startsWith('https') ? p.image : SERVER_BASE_URL + p.image;
        return `
          <div class="related-card" onclick="goToProduct('${p._id}')">
            <img src="${img}" alt="${p.title}">
            <div class="related-title" title="${p.title}">${p.title}</div>
            <div class="related-price">₹${Number(p.price).toLocaleString()}</div>
          </div>
        `;
      }).join('');

      relatedSection.style.display = 'block';
    }

    function goToProduct(id) {
      // Redirect to product page with new ID
      window.location.href = `${window.location.pathname}?id=${id}`;
    }

    // WhatsApp buy now
    function buyNow() {
      if (!currentProduct) return alert("Product not loaded.");

      const sellerPhone = currentProduct.sellerPhone;
      if (!sellerPhone || sellerPhone.length < 10) {
        return alert("Seller's WhatsApp number not available.");
      }

      const message = encodeURIComponent(
        `Hello, I am interested in your product "${currentProduct.title}" priced at ₹${currentProduct.price}. Please let me know more details.`
      );
      const whatsappURL = `https://wa.me/${sellerPhone}?text=${message}`;
      window.open(whatsappURL, '_blank');
    }

    // Normalize email helper to lowercase and trim spaces
    function normalizeEmail(email) {
      return email.toLowerCase().trim();
    }

    // Add to cart
    function addToCart() {
      if (!currentProduct) {
        alert("Product not loaded.");
        return;
      }

      if (!user || !user.email) {
        alert("⚠️ Please log in to add items to your cart.");
        return;
      }

      const normalizedEmail = normalizeEmail(user.email);

      const cartData = {
        userId: normalizedEmail,  // normalized email as userId
        productId: currentProduct._id,
        quantity: 1
      };

      // Send email as query param as your backend requires it
      fetch(`${SERVER_BASE_URL}/api/cart?email=${encodeURIComponent(normalizedEmail)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cartData)
      })
      .then(res => {
        if (!res.ok) throw new Error("Failed to add to cart");
        return res.json();
      })
      .then(data => {
        alert("✅ Product added to cart successfully!");
        console.log('Cart response:', data);
      })
      .catch(err => {
        console.error("Error adding to cart:", err);
        alert("❌ Failed to add product to cart.");
      });
    }
  </script>

</body>
</html>
