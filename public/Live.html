<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Products</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    #controls {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    input[type="text"], select {
      padding: 8px;
      font-size: 14px;
    }

    .btn-refresh {
      padding: 8px 12px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-refresh:hover {
      background-color: #0b7dda;
    }

    #userProducts {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .product {
      display: flex;
      gap: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      align-items: center;
    }

    .product img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
    }

    .product-details {
      flex-grow: 1;
    }

    .btn-delete {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 8px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-delete:hover {
      background-color: #d32f2f;
    }

    .no-products, .message {
      font-size: 16px;
      color: gray;
    }

    .message.success {
      color: green;
      margin-bottom: 10px;
    }

    #loadingSpinner {
      font-size: 24px;
      color: #999;
    }
  </style>
</head>
<body>
  <h2><i class="fas fa-box"></i> Your Products</h2>

  <div id="controls">
    <input type="text" id="searchInput" placeholder="Search your products..." />
    <select id="sortSelect">
      <option value="">Sort by</option>
      <option value="lowToHigh">Price: Low to High</option>
      <option value="highToLow">Price: High to Low</option>
    </select>
    <button class="btn-refresh" onclick="fetchUserProducts()">Refresh</button>
  </div>

  <p class="message" id="messageArea"></p>

  <div id="userProducts">
    <p class="no-products" id="loadingSpinner"><i class="fas fa-spinner fa-spin"></i> Loading your products...</p>
  </div>

  <script>
    const API_BASE = "http://10.146.16.7:4000";
    let allUserProducts = [];

    async function fetchUserProducts() {
      const container = document.getElementById('userProducts');
      const messageArea = document.getElementById('messageArea');
      container.innerHTML = '<p class="no-products" id="loadingSpinner"><i class="fas fa-spinner fa-spin"></i> Loading your products...</p>';
      messageArea.textContent = '';

      const userString = localStorage.getItem('user');
      if (!userString) {
        container.innerHTML = '<p class="no-products">Please log in to see your products.</p>';
        return;
      }

      const user = JSON.parse(userString);
      const userMobile = user.mobile || user.phone || user.number || user.whatsapp;

      if (!userMobile) {
        container.innerHTML = '<p class="no-products">Mobile number not found. Please log in again.</p>';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/products`);
        if (!response.ok) throw new Error('Failed to fetch products');

        const allProducts = await response.json();
        allUserProducts = allProducts.filter(p =>
          p.sellerPhone === userMobile || p.phone === userMobile
        );

        renderProducts(allUserProducts);
      } catch (error) {
        container.innerHTML = `<p class="no-products">Error loading products: ${error.message}</p>`;
      }
    }

    function renderProducts(products) {
      const container = document.getElementById('userProducts');

      if (products.length === 0) {
        container.innerHTML = '<p class="no-products">You have no products listed.</p>';
        return;
      }

      container.innerHTML = products.map(p => `
        <div class="product" data-id="${p._id}">
          <img src="${API_BASE}${p.image || '/placeholder.jpg'}" alt="${p.title}" />
          <div class="product-details">
            <h3>${p.title}</h3>
            <p>${p.description}</p>
            <p><strong>Condition:</strong> ${p.condition}</p>
            <p><strong>Price:</strong> â‚¹${p.price}</p>
          </div>
          <button class="btn-delete" onclick="deleteProduct('${p._id}')">Delete</button>
        </div>
      `).join('');
    }

    async function deleteProduct(id) {
      const confirmDelete = confirm("Are you sure you want to delete this product?");
      if (!confirmDelete) return;

      try {
        const response = await fetch(`${API_BASE}/api/products/${id}`, {
          method: 'DELETE',
        });

        if (!response.ok) {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to delete product');
          } else {
            const errorText = await response.text();
            throw new Error('Server returned non-JSON response: ' + errorText);
          }
        }

        // Remove from DOM and array
        document.querySelector(`[data-id="${id}"]`).remove();
        allUserProducts = allUserProducts.filter(p => p._id !== id);
        showMessage('Product deleted successfully', 'success');

      } catch (error) {
        console.error('Delete error:', error.message);
        alert('Error deleting product: ' + error.message);
      }
    }

    function showMessage(text, type = 'success') {
      const messageArea = document.getElementById('messageArea');
      messageArea.className = `message ${type}`;
      messageArea.textContent = text;

      setTimeout(() => {
        messageArea.textContent = '';
      }, 3000);
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
      const value = e.target.value.toLowerCase();
      const filtered = allUserProducts.filter(p =>
        p.title.toLowerCase().includes(value) ||
        p.description.toLowerCase().includes(value)
      );
      renderProducts(filtered);
    });

    document.getElementById('sortSelect').addEventListener('change', (e) => {
      const value = e.target.value;
      let sorted = [...allUserProducts];

      if (value === 'lowToHigh') {
        sorted.sort((a, b) => a.price - b.price);
      } else if (value === 'highToLow') {
        sorted.sort((a, b) => b.price - a.price);
      }

      renderProducts(sorted);
    });

    window.addEventListener('DOMContentLoaded', fetchUserProducts);
  </script>
</body>
</html>
